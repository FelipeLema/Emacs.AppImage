name: build-appimage
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: setup environment
        # gcc 10 available @ "Ubuntu > 16.xx": https://github.com/actions/virtual-environments/issues/1604#issuecomment-705498375
        run: |
          # common dependencies
          sudo apt-get install -qq -y libxpm-dev libjpeg-dev libgnutls28-dev libgif-dev libtiff-dev libacl1-dev libgtk-3-dev libwebkit2gtk-4.0-dev librsvg2-dev libmagickcore-dev libmagick++-dev libgpm-dev libselinux1-dev libm17n-dev libotf-dev libsystemd-dev
          # gcc-emacs + native JSON dependencies
          sudo apt-get install -qq -y libjansson-dev gcc-10 libgccjit0 libgccjit-10-dev


      - name: download
        run:
          git clone --depth 1 --single-branch --branch feature/native-comp https://git.savannah.gnu.org/git/emacs.git
      - name: configure
        env:
          CC: gcc-10
          CXX: g++-10
        working-directory: ./emacs
        run: |
          ./autogen.sh
          ./configure --prefix=/app --without-selinux --with-x-toolkit=gtk3 --with-modules --with-nativecomp || (cat config.log; exit -1)

      - name: build-and-install
        working-directory: ./emacs
        run: |
          make -j$(nproc) NATIVE_FULL_AOT=1
          sudo make install
          # WIP: pack using appimage.sh 

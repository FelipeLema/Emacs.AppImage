language: C
dist: focal
sudo: true
  
script:
  - set -e
  - git clone https://git.savannah.gnu.org/git/emacs.git
  - cd emacs*
  - git checkout feature/native-comp
  - sudo apt-get build-dep emacs
  - sudo apt-get -y install libgtk-3-dev libwebkit2gtk-4.0-dev libjansson-dev
  - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/ppa && sudo apt-get update -y && sudo apt-get install -y gcc-10 libgccjit0 libgccjit-10-dev
  - apt-file list libgccjit-10-dev
  - ./autogen.sh
  - ./configure --prefix=/app --without-selinux --with-x-toolkit=gtk3 --with-modules --with-nativecomp || (cat config.log; exit -1)
  - CC="gcc-10" make -j$(nproc) NATIVE_FULL_AOT=1
  - sudo make install
  - cd ..
  - sudo apt-get -y install squashfs-tools
  - bash -ex appimage.sh
  
after_success:
  - readlink -f .
  - wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
  - bash upload.sh ../../../out/*.AppImage*

branches:
  except:
    - # Do not build tags that we create when we upload to GitHub Releases
    - /^(?i:continuous)$/
